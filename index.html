<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ãã‚ãï¼ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ï¼</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (çœç•¥: å¤‰æ›´ãªã—) */
        body {
            font-family: "Hiragino Kaku Gothic ProN", "ãƒ¡ã‚¤ãƒªã‚ª", sans-serif;
            background-color: #FFF8E1; 
            color: #333;
            text-align: center;
            padding: 20px;
            margin: 0;
            user-select: none;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border: 4px solid #004D40; 
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: height 0.3s;
        }
        h1 {
            color: #004D40; 
            font-size: 28px;
            margin-bottom: 10px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #start-screen { display: block; }
        .start-lead {
            font-size: 18px;
            font-weight: bold;
            color: #FFC107;
            margin-bottom: 30px;
        }
        .start-desc {
            font-size: 15px;
            color: #555;
            margin-bottom: 40px;
            line-height: 1.6;
        }
        .start-btn-large {
            background-color: #FFC107; 
            color: #004D40; 
            border: none;
            border-radius: 50px;
            padding: 20px 40px;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 6px #FF8F00; 
            width: 80%;
            margin: 0 auto;
            display: block;
            animation: pulse 2s infinite;
        }
        .start-btn-large:active {
            transform: translateY(4px);
            box-shadow: 0 2px #FF8F00;
        }

        #quiz-area, #result-area { display: none; }
        .privacy-note {
            font-size: 13px;
            color: #1A795A;
            background-color: #E8F5E9;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            line-height: 1.5;
            text-align: left;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            height: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #FFC107;
            width: 0%;
            transition: width 0.3s ease;
        }
        .question-box {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 25px;
            min-height: 60px;
            padding: 10px;
            background-color: #E8F5E9; 
            border-radius: 10px;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        button.option-btn {
            background-color: #FFC107; 
            color: #333; 
            border: none;
            border-radius: 50px;
            padding: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 4px #FF8F00; 
            text-align: left;
            padding-left: 25px;
            font-weight: bold;
        }
        button.option-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 #FF8F00;
        }
        button.option-btn:hover {
            background-color: #FFB300;
        }
        button.neutral-btn {
            background-color: #bdbdbd;
            box-shadow: 0 4px #757575;
            color: white; 
        }
        button.neutral-btn:hover {
            background-color: #a0a0a0;
        }

        /* âª æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  */
        #back-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
            margin-bottom: -5px;
            transition: background-color 0.2s;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }
        #back-button:hover {
            background-color: #45a049;
        }
        
        /* çµæœç”»é¢ */
        .animal-icon {
            font-size: 100px;
            display: block;
            margin: 10px 0;
            animation: pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .type-title {
            font-size: 28px;
            color: #004D40; 
            font-weight: bold;
            margin-bottom: 5px;
        }
        .catchphrase {
            font-weight: bold;
            color: #FFC107; 
            font-size: 16px;
            margin-bottom: 15px;
        }
        .chart-container {
            position: relative;
            margin: 20px auto;
            height: 300px;
            width: 100%;
        }
        .desc {
            text-align: left;
            background: #FFFDE7; 
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            line-height: 1.8;
            border: 2px dashed #FFC107; 
        }
        .download-btn {
            background-color: #004D40;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px #00332B;
            width: 80%;
            margin: 15px auto 0;
            display: block;
            transition: transform 0.1s;
        }
        .download-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 #00332B;
        }
        .share-area {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .share-btn {
            padding: 10px 20px;
            border-radius: 5px;
            color: white;
            text-decoration: none;
            font-weight: bold;
            font-size: 14px;
            display: inline-block;
            text-align: center;
        }
        .share-twitter { background-color: #1DA1F2; }
        .share-line { background-color: #06C755; }
        .restart-btn {
            background-color: #1976D2; 
            box-shadow: 0 4px #0D47A1;
            margin-top: 30px;
            text-align: center;
            border-radius: 10px;
            color: white;
            width: 100%;
            padding: 15px 0;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        #growth-message {
            background-color: #E3F2FD;
            color: #0D47A1;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #BBDEFB;
        }
        @keyframes pop {
            0% {transform: scale(0);}
            100% {transform: scale(1);}
        }
        @keyframes pulse {
            0% {transform: scale(1);}
            50% {transform: scale(1.05);}
            100% {transform: scale(1);}
        }
    </style>
</head>
<body>

<div class="container">
    <div id="start-screen">
        <h1>ğŸ’ ã‚ãã‚ãï¼ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—è¨ºæ–­ï¼ ğŸ’</h1>
        <p class="start-lead">ã‚­ãƒŸã®ãŠé‡‘ã®ä½¿ã„æ–¹ã€ã©ã®å‹•ç‰©ã‚¿ã‚¤ãƒ—ï¼Ÿ</p>
        <div class="start-desc">
            <p id="loading-message">
                **ãƒ‡ãƒ¼ã‚¿æº–å‚™ä¸­...**<br>
                Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ€æ–°ã®è³ªå•ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚
            </p>
        </div>
        <button class="start-btn-large" id="start-button" onclick="startGame()" disabled>è¨ºæ–­ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>

    <div id="quiz-area">
        <p class="privacy-note">
            â€»å›ç­”ã¯æœ¬äººä»¥å¤–çŸ¥ã‚‹ã“ã¨ãŒã§ããªã„ä»•çµ„ã¿ã§ã™ã€‚æœ¬éŸ³ã§å›ç­”ã—ã¦ã­ã€‚
        </p>
        <p>ã—ã¤ã‚‚ã‚“ <span id="q-number">1</span> / <span id="q-total">16</span></p>
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div id="quiz-content" class="fade-in">
            <div class="question-box" id="question-text">ã“ã“ã«è³ªå•ãŒå‡ºã¾ã™</div>
            <div class="options" id="options-container"></div>
        </div>
        <button id="back-button" onclick="goBack()">âª ä¸€ã¤å‰ã«æˆ»ã‚‹</button>
    </div>

    <div id="result-area" class="result-area">
        <div id="growth-message"></div>
        <div id="result-content-container">
            <h1>è¨ºæ–­çµæœï¼</h1>
            <div id="result-content"></div>
            
            <div class="chart-container">
                <canvas id="radarChart"></canvas>
            </div>

            <div id="result-desc"></div>
        </div>

        <button onclick="downloadResultImage()" class="download-btn">çµæœç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ğŸ“¸</button>

        <div class="share-area">
            <a href="#" id="share-twitter" class="share-btn share-twitter" target="_blank">Xã§ã‚·ã‚§ã‚¢</a>
            <a href="#" id="share-line" class="share-btn share-line" target="_blank">LINEã§ã‚·ã‚§ã‚¢</a>
        </div>

        <button class="restart-btn" onclick="location.reload()">ã‚‚ã†ä¸€å›ã‚„ã‚‹ï¼</button>
    </div>
</div>

<script>
    // â˜…â˜…â˜… ã‚ãªãŸã®Apps Scriptã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼ â˜…â˜…â˜…
    // è¨ºæ–­çµæœã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«é€ä¿¡ã™ã‚‹Apps Scriptã®å…¬é–‹URL
    const GOOGLE_APP_URL = "https://script.google.com/macros/s/AKfycby8QPZgLdLGcklU0IIYqJ50t4dpo-N_nk0BaQToPEVLql9al3IkLG-mwq75pLn2M-kV/exec"; 
    // Q&Aãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€CSVã®å…¬é–‹URL (ãƒ•ã‚¡ã‚¤ãƒ« > å…±æœ‰ > ã‚¦ã‚§ãƒ–ã«å…¬é–‹ > questionsã‚·ãƒ¼ãƒˆ > CSV)
    const QUESTIONS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9pj-nSE8qg0GTy-VDTdvpDrIJuE6OiJbnE0cOyPtHoV5W98am4V3vKES6H9rlTBfaRxWcUsLuI1VE/pub?gid=0&single=true&output=csv"; 
    // çµæœãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€CSVã®å…¬é–‹URL (ãƒ•ã‚¡ã‚¤ãƒ« > å…±æœ‰ > ã‚¦ã‚§ãƒ–ã«å…¬é–‹ > resultsã‚·ãƒ¼ãƒˆ > CSV)
    const RESULTS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS9pj-nSE8qg0GTy-VDTdvpDrIJuE6OiJbnE0cOyPtHoV5W98am4V3vKES6H9rlTBfaRxWcUsLuI1VE/pub?gid=1023134718&single=true&output=csv";

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let audioCtx;
    let questions = []; // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã‚‹è³ªå•ãƒ‡ãƒ¼ã‚¿
    let results = {};   // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã‚‹çµæœãƒ‡ãƒ¼ã‚¿
    let currentQuestionIndex = 0;
    let scores = { A: 0, B: 0, C: 0, D: 0, E: 0, F: 0, G: 0, H: 0, N: 0 };
    let scoreHistory = []; // âª æˆ»ã‚‹æ©Ÿèƒ½ç”¨: ã‚¹ã‚³ã‚¢ã®å±¥æ­´ã‚’ä¿æŒ

    // --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆCMS Liteï¼‰---
    async function loadData() {
        document.getElementById('start-button').disabled = true;

        if (QUESTIONS_CSV_URL === "YOUR_QUESTIONS_CSV_URL" || RESULTS_CSV_URL === "YOUR_RESULTS_CSV_URL") {
            document.getElementById('loading-message').innerHTML = 'âš ï¸ **URLã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼**<br>`QUESTIONS_CSV_URL` ã¨ `RESULTS_CSV_URL` ã‚’ä¸Šæ›¸ãã—ãªã„ã¨å‹•ä½œã—ã¾ã›ã‚“ã€‚';
            return;
        }

        try {
            // è³ªå•ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            const qResponse = await fetch(QUESTIONS_CSV_URL);
            const qCsvText = await qResponse.text();
            questions = parseQuestionsCSV(qCsvText);
            
            // çµæœãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            const rResponse = await fetch(RESULTS_CSV_URL);
            const rCsvText = await rResponse.text();
            results = parseResultsCSV(rCsvText);

            if (questions.length === 0 || Object.keys(results).length === 0) {
                 throw new Error("CSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã‹ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒä¸æ­£ã§ã™ã€‚");
            }
            
            document.getElementById('loading-message').innerHTML = 'ãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†ï¼ã‚­ãƒŸã®ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—ã‚’è¨ºæ–­ã—ã‚ˆã†ï¼';
            document.getElementById('q-total').innerText = questions.length;
            document.getElementById('start-button').disabled = false;

        } catch (error) {
            console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            document.getElementById('loading-message').innerHTML = `ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>å…¬é–‹URLã¨CSVã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚(${error.message})`;
        }
    }

    // CSVè§£æãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function parseQuestionsCSV(csvText) {
        const rows = csvText.split('\n').filter(row => row.trim() !== '');
        if (rows.length < 2) return [];

        const data = [];
        const header = rows[0].split(',').map(h => h.trim());
        const optionColumns = header.filter(h => h.startsWith('opt'));
        
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].split(',').map(c => c.trim());
            if (cells.length === 0) continue;

            const q = { text: cells[header.indexOf('text')], options: [] };
            
            optionColumns.forEach((colName, index) => {
                const cellValue = cells[header.indexOf(colName)];
                if (cellValue) {
                    const match = cellValue.match(/(.*)\((.)\)/);
                    if (match) {
                        q.options.push({ text: match[1], type: match[2] });
                    }
                }
            });
            // æœ€å¾Œã«ã€Œã©ã¡ã‚‰ã§ã‚‚ãªã„ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            q.options.push({ text: "ã©ã‚Œã‚‚ã‚ã¾ã‚Šå½“ã¦ã¯ã¾ã‚‰ãªã„", type: "N" });
            data.push(q);
        }
        return data;
    }

    function parseResultsCSV(csvText) {
        const rows = csvText.split('\n').filter(row => row.trim() !== '');
        if (rows.length < 2) return {};

        const resultObj = {};
        const header = rows[0].split(',').map(h => h.trim());

        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].split(',').map(c => c.trim());
            if (cells.length === 0) continue;

            const type = cells[header.indexOf('type')];
            if (type) {
                resultObj[type] = {
                    animal: cells[header.indexOf('animal')],
                    title: cells[header.indexOf('title')],
                    catch: cells[header.indexOf('catch')],
                    desc: cells[header.indexOf('desc')]
                };
            }
        }
        return resultObj;
    }


    // --- éŸ³å£°ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  (Web Audio API) --- (çœç•¥: å¤‰æ›´ãªã—)
    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }
    function playTone(freq, type, duration, delay = 0) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
        
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration);

        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + delay);
        osc.stop(audioCtx.currentTime + delay + duration);
    }
    function playCoinSound() {
        initAudio();
        playTone(987, 'sine', 0.1);
        playTone(1318, 'sine', 0.4, 0.05);
    }
    function playClickSound() {
        initAudio();
        playTone(800, 'triangle', 0.1); 
    }
    function playFanfare() {
        initAudio();
        playTone(523.25, 'triangle', 0.3, 0);    
        playTone(659.25, 'triangle', 0.3, 0.15); 
        playTone(783.99, 'triangle', 0.3, 0.30); 
        playTone(1046.50, 'triangle', 0.8, 0.45);
    }

    // --- è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ ---

    function startGame() {
        initAudio(); 
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('quiz-area').style.display = 'block';

        playCoinSound(); 
        showQuestion(); 
    }

    function showQuestion() {
        // æœ€åˆã®è³ªå•ä»¥å¤–ã§ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('back-button').style.display = currentQuestionIndex > 0 ? 'block' : 'none';

        playClickSound(); 
        const quizContent = document.getElementById('quiz-content');
        
        quizContent.classList.remove('fade-in');
        void quizContent.offsetWidth; 
        quizContent.classList.add('fade-in');

        const q = questions[currentQuestionIndex];
        document.getElementById('question-text').innerText = q.text;
        document.getElementById('q-number').innerText = currentQuestionIndex + 1;
        
        const progress = ((currentQuestionIndex) / questions.length) * 100;
        document.getElementById('progress-bar').style.width = progress + "%";

        const optionsDiv = document.getElementById('options-container');
        optionsDiv.innerHTML = "";

        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.innerText = opt.text;
            btn.className = 'option-btn ' + (opt.type === "N" ? 'neutral-btn' : ''); 
            btn.onclick = () => selectOption(opt.type);
            optionsDiv.appendChild(btn);
        });
    }

    function selectOption(type) {
        // âª æˆ»ã‚‹æ©Ÿèƒ½ç”¨: ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã‚’å±¥æ­´ã«ä¿å­˜
        scoreHistory.push(JSON.parse(JSON.stringify(scores)));

        if (type !== "N") {
            scores[type]++;
        } else {
            scores.N++;
        }
        
        currentQuestionIndex++;

        if (currentQuestionIndex < questions.length) {
            showQuestion();
        } else {
            document.getElementById('progress-bar').style.width = "100%";
            showResult();
        }
    }

    // âª å‰ã®è³ªå•ã«æˆ»ã‚‹æ©Ÿèƒ½
    function goBack() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            
            // å±¥æ­´ã‹ã‚‰ä¸€ã¤å‰ã®ã‚¹ã‚³ã‚¢çŠ¶æ…‹ã‚’å¾©å…ƒ
            scores = scoreHistory.pop(); 
            
            showQuestion();
        }
    }

    function showResult() {
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';

        playFanfare(); 
        if (typeof confetti === 'function') { 
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        // --- çµæœåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
        const personalityScores = { A: scores.A, B: scores.B, C: scores.C, D: scores.D, E: scores.E, F: scores.F, G: scores.G, H: scores.H };
        let maxType = "A";
        let maxScore = 0;

        for (const type in personalityScores) {
            if (personalityScores[type] > maxScore) {
                maxScore = personalityScores[type];
                maxType = type;
            }
        }
        
        if (scores.N > maxScore || maxScore < 2) {
            maxType = "N";
        }

        const resultData = results[maxType];
        if (!resultData) {
             document.getElementById('result-content-container').innerHTML = '<h2>ã‚¨ãƒ©ãƒ¼: çµæœãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚resultsã‚·ãƒ¼ãƒˆã®ã‚¿ã‚¤ãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</h2>';
             return;
        }

        // --- Local Storageã‹ã‚‰éå»ã®ã‚¹ã‚³ã‚¢ã‚’å–å¾— ---
        const previousScoresString = localStorage.getItem('moneyQuizScores');
        let previousScores = null;
        let growthMessage = '';
        
        if (previousScoresString) {
            previousScores = JSON.parse(previousScoresString);
            growthMessage = generateGrowthMessage(previousScores, personalityScores);
        }
        
        // --- ä»Šå›ã®ã‚¹ã‚³ã‚¢ã‚’Local Storageã«ä¿å­˜ ---
        localStorage.setItem('moneyQuizScores', JSON.stringify(personalityScores));

        // --- ç”»é¢ã¸ã®åæ˜  ---
        document.getElementById('growth-message').innerHTML = growthMessage;

        sendResultToDatabase(maxType, maxScore);

        const content = `
            <span class="animal-icon">${resultData.animal}</span>
            <div class="type-title">${resultData.title}</div>
            <div class="catchphrase">${resultData.catch}</div>
        `;
        document.getElementById('result-content').innerHTML = content;
        document.getElementById('result-desc').innerHTML = `<div class="desc">${resultData.desc}</div>`;

        const shareText = `ç§ã®ãƒãƒãƒ¼ã‚¿ã‚¤ãƒ—ã¯â€¦ã€${resultData.title}ã€‘ã§ã—ãŸï¼%0a${resultData.catch}%0a%0a#ãƒãƒãƒ¼è¨ºæ–­`;
        const shareUrl = window.location.href;
        
        document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`;
        document.getElementById('share-line').href = `https://social-plugins.line.me/lineit/share?url=${shareUrl}`;

        drawChart(previousScores, personalityScores); 
    }

    // --- Local Storage æˆé•·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆé–¢æ•° --- (çœç•¥: å¤‰æ›´ãªã—)
    function generateGrowthMessage(prev, current) {
        const calcAxis = (s) => ({
            protect: s.A + s.G + s.C,
            use: s.B + s.F,
            increase: s.E + s.H,
            share: s.D * 2 
        });

        const prevAxis = calcAxis(prev);
        const currentAxis = calcAxis(current);

        const axisNames = { protect: 'è²¯é‡‘ãƒ»è¨ˆç”»æ€§', use: 'æ¶ˆè²»ãƒ»ç›´æ„Ÿæ€§', increase: 'æŠ•è³‡ãƒ»ç¨¼ãåŠ›', share: 'å…±æ„Ÿãƒ»åˆ©ä»–æ€§' };
        let improvement = [];
        let regression = [];

        for (const key in prevAxis) {
            const diff = currentAxis[key] - prevAxis[key];
            if (diff > 1) { 
                improvement.push(axisNames[key]);
            } else if (diff < -1) { 
                regression.push(axisNames[key]);
            }
        }
        
        let message = 'ãŠã‹ãˆã‚Šï¼å‰å›ã®è¨ºæ–­çµæœã¨æ¯”è¼ƒã™ã‚‹ã‚ˆã€‚';

        if (improvement.length > 0) {
            message += `<br>âœ¨ **ã‚­ãƒŸã¯ [${improvement.join(', ')}] ãŒå¤§ããæˆé•·ã—ãŸã­ï¼** ãƒãƒãƒ¼æ„è­˜ãŒå¤‰ã‚ã£ãŸè¨¼æ‹ ã ã‚ˆã€‚`;
        }
        if (regression.length > 0) {
            message += `<br>âš ï¸ ãŸã ã—ã€[${regression.join(', ')}] ã®æ„è­˜ãŒå°‘ã—ä¸‹ãŒã£ã¦ã„ã‚‹ã‹ã‚‚ã€‚ãƒãƒ©ãƒ³ã‚¹ã‚’æ„è­˜ã—ã¦ã¿ã¦ã­ã€‚`;
        }
        if (improvement.length === 0 && regression.length === 0) {
             message += `<br>ğŸ‘ **ç´ æ™´ã‚‰ã—ã„ï¼å‰å›ã®è»¸ã‚’ã—ã£ã‹ã‚Šã‚­ãƒ¼ãƒ—ã—ã¦ã„ã‚‹ã‚ˆã€‚**`;
        }
        
        return message;
    }


    // --- ãƒ‡ãƒ¼ã‚¿é›†è¨ˆæ©Ÿèƒ½ (Google Apps Scripté€£æº) --- (çœç•¥: å¤‰æ›´ãªã—)
    function sendResultToDatabase(resultType, maxScore) {
        if (GOOGLE_APP_URL === "https://docs.google.com/spreadsheets/d/1InK2EwHTmHCns3bMr4d53tVPYeelNSne_Y_59L_M4VU/edit?usp=sharing") {
            console.error("Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
            return;
        }

        const data = {
            type: resultType,
            score: maxScore,
            url: window.location.href
        };

        fetch(GOOGLE_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(data)
        })
        .then(response => {
            console.log("Result data sent successfully.");
        })
        .catch(error => {
            console.error('Error sending data:', error);
        });
    }

    // --- ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ (html2canvas) --- (çœç•¥: å¤‰æ›´ãªã—)
    function downloadResultImage() {
        const target = document.getElementById('result-content-container');
        
        if (typeof html2canvas === 'undefined') {
            alert('ç”»åƒç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        setTimeout(() => {
            html2canvas(target, {
                windowWidth: target.scrollWidth,
                windowHeight: target.scrollHeight,
                useCORS: true,
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'ãƒãƒãƒ¼è¨ºæ–­çµæœ.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }, 500);
    }
    
    // --- ãƒãƒ£ãƒ¼ãƒˆæç”»é–¢æ•° --- (çœç•¥: å¤‰æ›´ãªã—)
    function drawChart(previousScores, currentScores) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        
        const protect = currentScores.A + currentScores.G + currentScores.C;
        const use = currentScores.B + currentScores.F;
        const increase = currentScores.E + currentScores.H;
        const share = currentScores.D * 2;
        
        let datasets = [{
            label: 'ä»Šå›ã®ãƒãƒãƒ¼ãƒãƒ©ãƒ³ã‚¹',
            data: [protect, use, increase, share],
            backgroundColor: 'rgba(255, 193, 7, 0.4)',
            borderColor: '#FFC107',
            borderWidth: 2,
            pointBackgroundColor: '#004D40',
            pointRadius: 5
        }];
        
        if (previousScores) {
            const prevProtect = previousScores.A + previousScores.G + previousScores.C;
            const prevUse = previousScores.B + previousScores.F;
            const prevIncrease = previousScores.E + previousScores.H;
            const prevShare = previousScores.D * 2;
            
            datasets.unshift({ 
                label: 'å‰å›ã®ãƒãƒãƒ¼ãƒãƒ©ãƒ³ã‚¹',
                data: [prevProtect, prevUse, prevIncrease, prevShare],
                backgroundColor: 'rgba(0, 77, 64, 0.2)', 
                borderColor: '#004D40', 
                borderWidth: 1,
                pointBackgroundColor: '#004D40',
                pointRadius: 3,
                borderDash: [5, 5] 
            });
        }

        if (window.myRadarChart) {
            window.myRadarChart.destroy();
        }

        window.myRadarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['å®ˆã‚‹ãƒ»è¨ˆç”»', 'ä½¿ã†ãƒ»ç›´æ„Ÿ', 'å¢—ã‚„ã™ãƒ»çµŒé¨“', 'åˆ†ã‘ã‚‹ãƒ»å…±æ„Ÿ'],
                datasets: datasets
            },
            options: {
                scale: {
                    r: {
                        beginAtZero: true,
                        suggestedMax: 8,
                        grid: { color: '#ccc' },
                        pointLabels: {
                            font: { size: 14, weight: 'bold' },
                            color: '#004D40'
                        }
                    }
                },
                plugins: {
                    legend: { display: true } 
                }
            }
        });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹
    window.onload = loadData;
</script>
</body>
</html>
